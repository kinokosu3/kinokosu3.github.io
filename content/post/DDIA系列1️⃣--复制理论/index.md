---
title: DDIA系列1️⃣--复制理论
date: 2023-12-24 13:38:43
image: cover.png
tags:
    - 分布式数据系统
---


## 有状态的水平扩展
现实中负载增强后需要更强的处理能力，一般来说会分为两种扩展，水平扩展和垂直扩展。垂直扩展通常就是往一台机器上加更多的内存和CPU核心，成本较高，容错能力较差。水平扩展则是一台机器处理任务变成多台机器一起处理任务，相互协调通信全部运行在以太网上。无数据状态的水平扩展比较简单，无论是添加还是删除都不会给应用程序造成影响，而对于有数据状态的水平扩展(例如数据库)，通常来说会有两种方式：
* 复制
* 分区

## 复制
复制通常为了解决几个问题：贴近用户，降低访问延迟、高可用、读吞吐量。
复制中的所有挑战都是为了解决持续更改中的复制问题。
其中流行的三种复制方法有：
* 主从复制
* 多主节点复制
* 无主节点复制

### 主从复制
每个保存数据库完整数据集的节点称之为副本。复制设计中分为两种，一种是同步复制一种是异步复制。

同步复制好处是，从节点可以确保完成和主节点的更新同步。坏处是每次更改都需要等待从节点确认，最差情况会阻塞当前操作。

其中有一种设计是半同步，只有一个节点是同步复制的，如果同步的从节点变得不可用，就可以提升异步的从节点为同步。这样可以确保至少有两个节点拥有最新的副本。

如果是全异步模式，很有可能会在主节点还没来及的发送写请求却宕机，但是客户端已经确认了。这样无法保证数据的持久化。

如果加入了新的从节点，这时候主节点通常还是会对外保持服务，源源不断产生写请求。通常来说数据库系统会对数据产生一个快照，避免锁住整个数据库(不可接受)，然后拷贝快照到从节点。接下来快照时间后所有产生数据更改日志也会发给从节点，这样被称为`追赶`。

接下来讨论最关键的高可用(宕机)环节。

#### 节点失效

从节点失效：追赶式恢复，根据副本的复制日志，可以知道故障前最后处理的事务，然后去主节点拿到这个事务后所有的数据变更。

主节点失效：节点切换。分为三个步骤，确认主节点失效，选举新的主节点，重新配置系统生效主节点。最后一步中客户端需要将请求发送给新的主节点，如果旧的主节点重新上线，可能还自认为是主节点（脑裂），系统需要确保旧的主节点降级为从节点。
如果是异步复制，就有可能导致数据丢失，如果失效前的数据没有被复制出去，重新上线后可能会给其他从节点发送同步请求，这样的话只能丢弃旧主节点上的数据。
如果使用丢失数据的方式来解决数据复制不同步的问题，首先会破坏数据持久化，其次，如果依赖了Redis缓存等外部组件，可能会出现数据不一致，导致数据错误或泄漏。


#### 复制日志

基于语句的复制，所有操作日志发给从节点，但是有一些问题，例如NOW获取当前时间，在从节点就会产生不同的值。或者是使用了自增列，就必须顺序执行。
基于WAL预写日志的复制，所有对数据库写入的字节序列都写入日志，然后发送给从节点重放。但是这种数据过于底层，必须与存储引擎紧密结合才能生效。
基于行的逻辑日志的复制，逻辑日志指一系列记录描述对行级别的写请求，例如行插入、行删除、行更新。MySQL的binlog就是其中一种。

#### 复制滞后(最终一致性)

完全同步复制的系统在现实中非常不可靠，如果其中只要一个节点发生故障整个系统就不能写入了。所以说只能用异步复制，但是使用异步复制就会导致客户端访问从节点会读到过期的消息。
接下来讨论复制滞后的问题与一些解决思路。
